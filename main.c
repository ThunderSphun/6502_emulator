#include "bus.h"

#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>

uint8_t read(uint16_t addr) {
	(void) addr;
	return 0;
}
void write(uint16_t addr, uint8_t data) {
	(void) addr;
	(void) data;
}

#define TEST(from, to, read, write) \
	bus_init(); \
	printf("%04X - %04X\t(%c%c)\treturned ", from, to, read ? 'R' : '_', write ? 'W' : '_'); \
	if (bus_add(read, write, from, to)) { \
		printf("true\n"); \
		bus_print(); \
		printf("\n\n"); \
	} else {\
		printf("false\n"); \
	} \
	bus_destroy()

int main() {
	bus_init();
	printf("- initial state\n");
	bus_print();
	bus_destroy();
	printf("\n\n");

	// replace entire section (breaking no edges)
	TEST(0x0000, 0x00FF, read, write); // 0x0000 - 0x00FF, 0x0100 - 0x7FFF, 0x8000 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0x0100, 0x7FFF, read, write); // 0x0000 - 0x00FF, 0x0100 - 0x7FFF, 0x8000 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0x8000, 0xFEFF, read, write); // 0x0000 - 0x00FF, 0x0100 - 0x7FFF, 0x8000 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0xFF00, 0xFFFF, read, write); // 0x0000 - 0x00FF, 0x0100 - 0x7FFF, 0x8000 - 0xFEFF, 0xFF00 - 0xFFFF

	// expanding section from start (breaking no edges)
	TEST(0x0000, 0x007F, read, write); // 0x0000 - 0x007F, 0x0080 - 0x00FF, 0x0100 - 0x7FFF, 0x8000 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0x0100, 0x3FFF, read, write); // 0x0000 - 0x00FF, 0x0100 - 0x3FFF, 0x4000 - 0x7FFF, 0x8000 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0x8000, 0xBFFF, read, write); // 0x0000 - 0x00FF, 0x0100 - 0x7FFF, 0x8000 - 0xBFFF, 0xC000 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0xFF00, 0xFF7F, read, write); // 0x0000 - 0x00FF, 0x0100 - 0x7FFF, 0x8000 - 0xFEFF, 0xFF00 - 0xFF7F, 0xFF80 - 0xFFFF

	// expanding section from stop (breaking no edges)
	TEST(0x0080, 0x00FF, read, write); // 0x0000 - 0x007F, 0x0080 - 0x00FF, 0x0100 - 0x7FFF, 0x8000 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0x4000, 0x7FFF, read, write); // 0x0000 - 0x00FF, 0x0100 - 0x3FFF, 0x4000 - 0x7FFF, 0x8000 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0xC000, 0xFEFF, read, write); // 0x0000 - 0x00FF, 0x0100 - 0x7FFF, 0x8000 - 0xBFFF, 0xC000 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0xFF80, 0xFFFF, read, write); // 0x0000 - 0x00FF, 0x0100 - 0x7FFF, 0x8000 - 0xFEFF, 0xFF00 - 0xFF7F, 0xFF80 - 0xFFFF

	// expanding section in center (breaking no edges)
	TEST(0x0040, 0x00BF, read, write); // 0x0000 - 0x003F, 0x0040 - 0x00BF, 0x00C0 - 0x00FF, 0x0100 - 0x7FFF, 0x8000 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0x0200, 0x6FFF, read, write); // 0x0000 - 0x00FF, 0x0100 - 0x01FF, 0x0200 - 0x6FFF, 0x7000 - 0x7FFF, 0x8000 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0x9000, 0xFDFF, read, write); // 0x0000 - 0x00FF, 0x0100 - 0x7FFF, 0x8000 - 0x8FFF, 0x9000 - 0xFDFF, 0xFE00 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0xFF40, 0xFFBF, read, write); // 0x0000 - 0x00FF, 0x0100 - 0x7FFF, 0x8000 - 0xFEFF, 0xFF00 - 0xFF3F, 0xFF40 - 0xFFBF, 0xFFC0 - 0xFFFF

	// break each edge (one edge per edit)
	TEST(0x0000, 0x01FF, read, write); // 0x0000 - 0x01FF, 0x0200 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0x0000, 0x7FFF, read, write); // 0x0000 - 0x7FFF, 0x8000 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0x0100, 0xFEFF, read, write); // 0x0000 - 0x00FF, 0x0100 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0x8000, 0xFFFF, read, write); // 0x0000 - 0x00FF, 0x0100 - 0x7FFF, 0x8000 - 0xFFFF
	TEST(0xFE00, 0xFFFF, read, write); // 0x0000 - 0x00FF, 0x0100 - 0xFDFF, 0xFE00 - 0xFFFF

	// break two edges
	TEST(0x0000, 0xFEFF, read, write); // 0x0000 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0x0080, 0xFEFF, read, write); // 0x0000 - 0x007F, 0x0080 - 0xFFEF, 0xFF00 - 0xFFFF
	TEST(0x0000, 0xFDFF, read, write); // 0x0000 - 0xFDFF, 0xFE00 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0x0080, 0xFDFF, read, write); // 0x0000 - 0x007F, 0x0080 - 0xFDFF, 0xFE00 - 0xFEFF, 0xFF00 - 0xFFFF
	TEST(0x0100, 0xFFFF, read, write); // 0x0000 - 0x00FF, 0x0100 - 0xFFFF
	TEST(0x0200, 0xFFFF, read, write); // 0x0000 - 0x00FF, 0x0100 - 0x01FF, 0x0200 - 0xFFFF
	TEST(0x0100, 0xFF7F, read, write); // 0x0000 - 0x00FF, 0x0100 - 0xFF7F, 0xFF80 - 0xFFFF
	TEST(0x0200, 0xFF7F, read, write); // 0x0000 - 0x00FF, 0x0100 - 0x01FF, 0x0200 - 0xFF7F, 0xFF80 - 0xFFFF

	// break each edge at once
	TEST(0x0080, 0xFF7F, read, write); // 0x0000 - 0x007F, 0x0080 - 0xFF7F, 0xFF80 - 0xFFFF
	TEST(0x0000, 0xFFFF, read, write); // 0x0000 - 0xFFFF

	return 0;
}